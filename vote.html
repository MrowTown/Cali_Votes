<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cali Votes — Vote</title>
  <link rel="stylesheet" href="style.css" />
  <script src="config.js"></script>
  <script src="app.js"></script>
  <style>
    .wrap { max-width: 900px; margin: 24px auto; padding: 0 14px; }
    .topbar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-bottom: 14px; }
    .pill { padding: 6px 10px; border-radius: 999px; background: rgba(0,0,0,.08); font-size: 13px; }
    .btn { display:inline-block; padding:10px 14px; border-radius: 14px; border: 0; cursor:pointer; font-weight: 800; }
    .btn-danger { background:#ff245a; color:#fff; }
    .btn-secondary { background:#111; color:#fff; border:1px solid rgba(0,0,0,.18); }
    .card { padding: 16px; border-radius: 16px; background: rgba(0,0,0,.06); }
    .msg { margin-top:12px; padding:10px 12px; border-radius:12px; display:none; }
    .err { background: rgba(255,0,80,.12); border: 1px solid rgba(255,0,80,.25); }
  </style>
</head>
<body>
  <div id="sessionBanner"></div>

  <div class="wrap">
    <div class="topbar">
      <div class="pill">Verified as: <span id="who">—</span></div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button id="btnBack" class="btn btn-secondary" type="button">Back</button>
        <button id="btnSwitch" class="btn btn-danger" type="button">Switch email</button>
      </div>
    </div>

    <div id="msgErr" class="msg err"></div>

    <div class="card">
      <h1>Choose your votes</h1>
      <p class="muted">Pick your city, number of votes, and payment method.</p>

      <form id="voteForm" class="stack">
        <label class="label">
          City
          <input id="city" type="text" required placeholder="e.g., New York, NY" />
        </label>

        <label class="label">
          Votes
          <input id="votes_claimed" type="number" min="1" step="1" required placeholder="1" />
        </label>

        <label class="label">
          Payment method
          <select id="payment_method_selected" required>
            <option value="" selected disabled>Select one…</option>
            <option value="CashApp">CashApp</option>
            <option value="Venmo">Venmo</option>
            <option value="SOL">SOL</option>
            <option value="ETH">ETH</option>
            <option value="BTC">BTC</option>
          </select>
        </label>

        <button class="btn" type="submit">Continue to Checkout</button>
      </form>

      <div class="row" style="gap:12px; margin-top:16px;">
        <a class="btn secondary" href="landing.html">Back</a>
        <a class="btn secondary" href="upload_entry.html">Already paid? Upload proof</a>
      </div>
    </div>
  </div>

  <script>
    const msgErr = document.getElementById("msgErr");
    const who = document.getElementById("who");
    const btnSwitch = document.getElementById("btnSwitch");
    const btnBack = document.getElementById("btnBack");
    const form = document.getElementById("voteForm");

    function showErr(html){
      msgErr.innerHTML = html;
      msgErr.style.display = "block";
    }

    function loadVoteDraft(){
      const raw = localStorage.getItem("cali_vote_payload");
      if (!raw) return null;
      try { return JSON.parse(raw); } catch (_) { return null; }
    }

    (function boot(){
      const s = getSession();
      if (!s.session_token || !s.email) {
        window.location.href = "landing.html";
        return;
      }
      who.textContent = s.email;

      const draft = loadVoteDraft();
      if (draft) {
        document.getElementById("city").value = draft.city || "";
        document.getElementById("votes_claimed").value = draft.votes_claimed || "";
        if (draft.payment_method_selected) {
          document.getElementById("payment_method_selected").value = draft.payment_method_selected;
        }
      }
    })();

    btnBack.addEventListener("click", () => {
      window.location.href = "landing.html";
    });

    btnSwitch.addEventListener("click", () => {
      clearSession();
      window.location.href = "register.html";
    });

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      msgErr.style.display = "none";

      const city = document.getElementById("city").value.trim();
      const votes = Number(document.getElementById("votes_claimed").value || 0);
      const payment = document.getElementById("payment_method_selected").value;

      if (!city) return showErr("City is required.");
      if (!votes || votes <= 0) return showErr("Votes must be at least 1.");
      if (!payment) return showErr("Choose a payment method.");

      const payload = {
        city,
        votes_claimed: votes,
        payment_method_selected: payment
      };
      localStorage.setItem("cali_vote_payload", JSON.stringify(payload));
      window.location.href = "pay.html";
    });
  </script>
  <script>mountSessionBanner();</script>
</body>
</html>
