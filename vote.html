<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cali Votes — Vote</title>
  <link rel="stylesheet" href="style.css" />
  <script src="config.js"></script>
  <script src="app.js"></script>
  <style>
    .wrap { max-width: 900px; margin: 24px auto; padding: 0 14px; }
    .topbar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-bottom: 14px; }
    .pill { padding: 6px 10px; border-radius: 999px; background: rgba(0,0,0,.08); font-size: 13px; }
    .btn { display:inline-block; padding:10px 14px; border-radius: 14px; border: 0; cursor:pointer; font-weight: 800; }
    .btn-danger { background:#ff245a; color:#fff; }
    .btn-secondary { background:#111; color:#fff; border:1px solid rgba(0,0,0,.18); }
    .card { padding: 16px; border-radius: 16px; background: rgba(0,0,0,.06); }
    .msg { margin-top:12px; padding:10px 12px; border-radius:12px; display:none; }
    .err { background: rgba(255,0,80,.12); border: 1px solid rgba(255,0,80,.25); }
  </style>
</head>
<body>
  <div id="sessionBanner"></div>

  <div class="wrap">
    <div class="topbar">
      <div class="pill">Verified as: <span id="who">—</span></div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button id="btnBack" class="btn btn-secondary" type="button">Back</button>
        <button id="btnSwitch" class="btn btn-danger" type="button">Switch email</button>
      </div>
    </div>

    <div id="msgErr" class="msg err"></div>

    <div class="card">
      <h1>Choose your votes</h1>
      <p class="muted">Pick your city, number of votes, and payment method.</p>
      <div class="instruction-card">
        <div class="instruction-title">This step</div>
        <div class="instruction-body">Enter your city, select how many votes, and choose a payment method. Next: you’ll see the checkout details and payment QR.</div>
      </div>

      <form id="voteForm" class="stack">
        <label class="label">
          City
          <input id="city" type="text" required placeholder="e.g., New York, NY" />
        </label>

        <label class="label">
          Votes
          <input id="votes_claimed" type="number" min="1" step="1" required placeholder="1" />
        </label>

        <label class="label">
          Payment method
          <select id="payment_method_selected" required>
            <option value="" selected disabled>Select one…</option>
            <option value="CashApp">CashApp</option>
            <option value="Venmo">Venmo</option>
            <option value="SOL">SOL</option>
            <option value="ETH">ETH</option>
            <option value="BTC">BTC</option>
          </select>
        </label>

        <button id="btnSubmit" class="btn" type="submit">Continue to Checkout</button>
      </form>

      <div class="row" style="gap:12px; margin-top:16px;">
        <a class="btn secondary" href="landing.html">Back</a>
        <a class="btn secondary" href="upload_entry.html">Already paid? Upload proof</a>
      </div>
    </div>
  </div>

  <script>
    const msgErr = document.getElementById("msgErr");
    const who = document.getElementById("who");
    const btnSwitch = document.getElementById("btnSwitch");
    const btnBack = document.getElementById("btnBack");
    const form = document.getElementById("voteForm");
    const btnSubmit = document.getElementById("btnSubmit");

    const INVOICE_KEY = "cali_invoice"; // Single source of truth for invoice state (vote -> pay).
    const DRAFT_KEY = "cali_vote_payload";
    const INVOICE_ERROR_KEY = "cali_invoice_error";

    function showErr(html){
      msgErr.innerHTML = html;
      msgErr.style.display = "block";
    }

    function loadVoteDraft(){
      const raw = localStorage.getItem(DRAFT_KEY);
      if (!raw) return null;
      try { return JSON.parse(raw); } catch (_) { return null; }
    }

    function saveInvoice(invoice){
      localStorage.setItem(INVOICE_KEY, JSON.stringify(invoice));
    }

    function buildUploadUrl(upload_url, upload_token){
      if (upload_url) return upload_url;
      if (upload_token) {
        const base = (window.location.origin + window.location.pathname).replace(/\/[^\/]*$/, "");
        return base + "/upload.html?token=" + encodeURIComponent(upload_token);
      }
      return "";
    }

    (function boot(){
      const s = getSession();
      if (!s.session_token || !s.email) {
        window.location.href = "landing.html";
        return;
      }
      who.textContent = s.email;

      const invoiceErr = localStorage.getItem(INVOICE_ERROR_KEY);
      if (invoiceErr) {
        localStorage.removeItem(INVOICE_ERROR_KEY);
        showErr(invoiceErr);
      }

      const draft = loadVoteDraft();
      if (draft) {
        document.getElementById("city").value = draft.city || "";
        document.getElementById("votes_claimed").value = draft.votes_claimed || "";
        if (draft.payment_method_selected) {
          document.getElementById("payment_method_selected").value = draft.payment_method_selected;
        }
      }
    })();

    btnBack.addEventListener("click", () => {
      window.location.href = "landing.html";
    });

    btnSwitch.addEventListener("click", () => {
      clearSession();
      window.location.href = "landing.html";
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      msgErr.style.display = "none";

      const city = document.getElementById("city").value.trim();
      const votes = Number(document.getElementById("votes_claimed").value || 0);
      const payment = document.getElementById("payment_method_selected").value;

      if (!city) return showErr("City is required.");
      if (!votes || votes <= 0) return showErr("Votes must be at least 1.");
      if (!payment) return showErr("Choose a payment method.");

      const s = getSession();
      if (!s.session_token) return showErr("Session expired. Please verify your email again.");

      btnSubmit.disabled = true;

      const res = await post("submitVote", {
        session_token: s.session_token,
        city,
        votes_claimed: votes,
        payment_method_selected: payment
      });

      if (res.error) {
        btnSubmit.disabled = false;
        return showErr("Error: " + esc(res.error));
      }

      if (!res.ok && !res.upload_url && !res.upload_token) {
        btnSubmit.disabled = false;
        return showErr("Could not create invoice. Please try again.");
      }

      const uploadUrl = buildUploadUrl(res.upload_url || "", res.upload_token || "");
      const invoice = {
        city,
        votes_claimed: votes,
        payment_method_selected: payment,
        amount_due_usd: Number(res.amount_due_usd || (votes * 5)),
        upload_url: uploadUrl,
        upload_token: res.upload_token || "",
        submission_id: res.submission_id || res.submissionId || res.id || ""
      };

      localStorage.setItem(DRAFT_KEY, JSON.stringify({
        city,
        votes_claimed: votes,
        payment_method_selected: payment
      }));
      saveInvoice(invoice);
      if (uploadUrl) localStorage.setItem("cali_last_upload_url", uploadUrl);

      window.location.href = "pay.html";
    });
  </script>
  <script>mountSessionBanner();</script>
</body>
</html>
