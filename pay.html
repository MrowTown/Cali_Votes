<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cali Votes — Checkout</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="sessionBanner"></div>

  <main class="wrap">
    <section class="card">
      <h1>Checkout</h1>
      <p class="muted">Pay the amount below, then upload your proof.</p>
      <div class="instruction-card">
        <div class="instruction-title">This step</div>
        <div class="instruction-body">Send payment using the method you selected. Next: upload a screenshot of the payment to finish.</div>
      </div>

      <div class="stack" style="margin-top:12px;">
        <div><span class="muted">City:</span> <b id="pay_city">—</b></div>
        <div><span class="muted">Votes:</span> <b id="pay_votes">—</b></div>
        <div><span class="muted">Amount due:</span> <b id="pay_amount">—</b></div>
        <div><span class="muted">Payment method:</span> <b id="pay_method">—</b></div>
      </div>

      <div style="margin-top:14px;">
        <img id="pay_qr" class="qr" style="display:none;" alt="Payment QR" />
      </div>

      <p id="msg" class="msg" style="margin-top:12px;"></p>

      <div class="row" style="gap:12px; margin-top:14px;">
        <button id="createSubmission" class="btn" type="button">I’ve paid — Continue to Upload</button>
        <a class="btn secondary" href="landing.html">Back</a>
      </div>

      <div class="row" style="gap:12px; margin-top:10px;">
        <a class="btn secondary" href="upload_entry.html">Already have proof? Upload now</a>
      </div>
    </section>
  </main>

  <script src="config.js"></script>
  <script src="app.js"></script>
  <script>
    const msg = document.getElementById("msg");
    const btn = document.getElementById("createSubmission");
    const qrImg = document.getElementById("pay_qr");

    const INVOICE_KEY = "cali_invoice"; // Single source of truth for invoice state (vote -> pay).
    const INVOICE_ERROR_KEY = "cali_invoice_error";

    function show(type, text){
      msg.className = "msg " + (type || "");
      msg.textContent = text || "";
      msg.style.display = text ? "block" : "none";
    }

    function loadInvoice(){
      const raw = localStorage.getItem(INVOICE_KEY);
      if (!raw) return null;
      try { return JSON.parse(raw); } catch (_) { return null; }
    }

    function saveInvoice(invoice){
      localStorage.setItem(INVOICE_KEY, JSON.stringify(invoice));
    }

    function buildUploadUrl(upload_url, upload_token){
      if (upload_url) return upload_url;
      if (upload_token) {
        const base = (window.location.origin + window.location.pathname).replace(/\/[^\/]*$/, "");
        return base + "/upload.html?token=" + encodeURIComponent(upload_token);
      }
      return "";
    }

    function buildQrSrc(file){
      const base = cfg().ASSET_BASE.replace(/\/+$/, "");
      if (base.toLowerCase().endsWith("/assets")) return base + "/" + file;
      return base + "/assets/" + file;
    }

    function renderInvoice(data){
      const city = data.city || "";
      const votes = Number(data.votes_claimed || 0);
      const payment = data.payment_method_selected || "";
      const amount = Number(data.amount_due_usd || (votes * 5));

      if (!city || !votes || !payment) {
        return false;
      }

      document.getElementById("pay_city").textContent = city;
      document.getElementById("pay_votes").textContent = String(votes);
      document.getElementById("pay_amount").textContent = "$" + String(Math.round(amount));
      document.getElementById("pay_method").textContent = payment;

      const qrMap = {
        CashApp: "cashapp-qr.png",
        Venmo: "venmo-qr.png",
        SOL: "sol-qr.png",
        ETH: "eth-qr.png",
        BTC: "btc-qr.png"
      };

      const file = qrMap[payment];
      if (file) {
        qrImg.src = buildQrSrc(file);
        qrImg.style.display = "block";
      } else {
        show("err", "Unknown payment method selected.");
      }

      return true;
    }

    (function boot(){
      const s = getSession();
      if (!s.session_token || !s.email) {
        window.location.href = "landing.html";
        return;
      }

      const invoice = loadInvoice();
      if (!invoice) {
        localStorage.setItem(INVOICE_ERROR_KEY, "Missing invoice. Please generate your invoice again.");
        window.location.href = "landing.html";
        return;
      }

      invoice.upload_url = buildUploadUrl(invoice.upload_url || "", invoice.upload_token || "");
      saveInvoice(invoice);

      if (!renderInvoice(invoice)) {
        localStorage.setItem(INVOICE_ERROR_KEY, "Invoice data is incomplete. Please generate your invoice again.");
        window.location.href = "landing.html";
        return;
      }

      if (invoice.upload_url) localStorage.setItem("cali_last_upload_url", invoice.upload_url);
    })();

    btn.addEventListener("click", () => {
      btn.disabled = true;
      msg.textContent = "";

      const invoice = loadInvoice();
      if (!invoice) {
        show("err", "Missing invoice. Please go back and generate again.");
        btn.disabled = false;
        return;
      }

      const uploadUrl = buildUploadUrl(invoice.upload_url || "", invoice.upload_token || "");
      if (!uploadUrl) {
        show("err", "Upload link missing. Please try again.");
        btn.disabled = false;
        return;
      }

      invoice.upload_url = uploadUrl;
      saveInvoice(invoice);
      window.location.href = uploadUrl;
    });
  </script>
  <script>mountSessionBanner();</script>
</body>
</html>
